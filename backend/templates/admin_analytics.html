{% extends "base.html" %}

{% block title %}Analytics et Pr√©dictions - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> Analytics et Pr√©dictions des Visites</h1>
            <p class="text-muted">Analyse des donn√©es de visite et pr√©dictions Machine Learning</p>
        </div>
    </div>

    <!-- Statistiques g√©n√©rales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Visites</h5>
                            <h3>{{ stats.get('total_visits', 0) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Visiteurs Uniques</h5>
                            <h3>{{ stats.get('unique_visitors', 0) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Aujourd'hui</h5>
                            <h3>{{ stats.get('visits_today', 0) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Cette Semaine</h5>
                            <h3>{{ stats.get('visits_this_week', 0) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-week fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <!-- Graphique des visites quotidiennes -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> √âvolution des Visites</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyVisitsChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Graphique des heures de pointe -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Heures de Pointe</h5>
                </div>
                <div class="card-body">
                    <canvas id="hourlyChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Pr√©dictions ML -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-brain"></i> Pr√©dictions Machine Learning</h5>
                    <button id="retrainBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> R√©-entra√Æner
                    </button>
                </div>
                <div class="card-body">
                    <!-- Informations de debug -->
                    {% if stats.get('debug_info') %}
                    <div class="alert alert-info">
                        <strong>üîç Informations de debug :</strong><br>
                        {% if stats.debug_info is string %}
                            {{ stats.debug_info }}
                        {% else %}
                            <ul class="mb-0">
                                <li>Total visites : {{ stats.debug_info.total_visits }}</li>
                                <li>Jours uniques : {{ stats.debug_info.unique_days }}</li>
                                <li>P√©riode : {{ stats.debug_info.date_range }}</li>
                                <li>R√©partition par jour :
                                    {% for date, count in stats.debug_info.visits_per_day.items() %}
                                        {{ date }} ({{ count }} visites){% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </li>
                            </ul>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if training_result.get('success') %}
                        <div class="alert alert-success">
                            <strong>Mod√®le entra√Æn√© !</strong>
                            R¬≤ = {{ "%.3f"|format(training_result.get('metrics', {}).get('r2', 0)) }}
                            ({{ training_result.get('metrics', {}).get('training_samples', 0) }} √©chantillons)
                        </div>

                        <!-- Debug: afficher les pr√©dictions brutes -->
                        {% if predictions %}
                            <div class="alert alert-info">
                                <strong>üîß Debug pr√©dictions :</strong><br>
                                Nombre de pr√©dictions : {{ predictions|length }}<br>
                                Donn√©es brutes : {{ predictions }}
                            </div>

                            <canvas id="predictionsChart" height="100"></canvas>

                            <div class="table-responsive mt-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Visites Pr√©dites</th>
                                            <th>Confiance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pred in predictions %}
                                        <tr>
                                            <td>{{ pred.date }}</td>
                                            <td><span class="badge bg-primary text-white">{{ pred.predicted_visits }}</span></td>
                                            <td>
                                                {% if pred.confidence == 'high' %}
                                                    <span class="badge bg-success text-white">√âlev√©e</span>
                                                {% elif pred.confidence == 'medium' %}
                                                    <span class="badge bg-warning text-dark">Moyenne</span>
                                                {% elif pred.confidence == 'low' %}
                                                    <span class="badge bg-secondary text-white">Faible</span>
                                                {% else %}
                                                    <span class="badge bg-dark text-white">{{ pred.confidence }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>Aucune pr√©diction g√©n√©r√©e</strong><br>
                                Variable predictions : {{ predictions }}<br>
                                Type : {{ predictions.__class__.__name__ if predictions else 'None' }}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <strong>Mod√®le non disponible :</strong> {{ training_result.get('message', 'Erreur inconnue') }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Insights automatiques -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb"></i> Insights Automatiques</h5>
                </div>
                <div class="card-body">
                    {% if insights %}
                        {% for insight in insights %}
                            <div class="alert alert-info alert-sm py-2 mb-2">
                                {{ insight }}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Pas assez de donn√©es pour g√©n√©rer des insights.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Pages populaires -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-fire"></i> Pages les Plus Visit√©es</h5>
                </div>
                <div class="card-body">
                    {% if stats.get('popular_pages') %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Page</th>
                                        <th>Visites</th>
                                        <th>Pourcentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for page in stats.get('popular_pages', []) %}
                                    <tr>
                                        <td><code>{{ page.url }}</code></td>
                                        <td><span class="badge bg-primary text-white">{{ page.visits }}</span></td>
                                        <td>
                                            {% set percentage = (page.visits / stats.get('total_visits', 1) * 100) %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ percentage }}%">
                                                    {{ "%.1f"|format(percentage) }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">Aucune donn√©e de page disponible.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Donn√©es des graphiques pass√©es depuis Python
const dailyData = {{ stats.get('daily_data', []) | tojson }};
const hourlyData = {{ stats.get('hourly_data', []) | tojson }};
const predictions = {{ predictions | tojson }};

// Graphique des visites quotidiennes
if (dailyData.length > 0) {
    const ctx1 = document.getElementById('dailyVisitsChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'Visites',
                data: dailyData.map(d => d.visits),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '√âvolution quotidienne des visites'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Graphique des heures de pointe
if (hourlyData.length > 0) {
    const ctx2 = document.getElementById('hourlyChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: hourlyData.map(d => d.hour + 'h'),
            datasets: [{
                label: 'Visites',
                data: hourlyData.map(d => d.visits),
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'R√©partition par heure'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Graphique des pr√©dictions
if (predictions.length > 0) {
    const ctx3 = document.getElementById('predictionsChart').getContext('2d');
    new Chart(ctx3, {
        type: 'line',
        data: {
            labels: predictions.map(p => p.date),
            datasets: [{
                label: 'Pr√©dictions',
                data: predictions.map(p => p.predicted_visits),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderDash: [5, 5],
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Pr√©dictions des visites pour les 7 prochains jours'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Bouton de r√©-entra√Ænement
document.getElementById('retrainBtn').addEventListener('click', function() {
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entra√Ænement...';
    this.disabled = true;

    fetch('/api/analytics/retrain', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erreur: ' + error);
        })
        .finally(() => {
            this.innerHTML = '<i class="fas fa-sync-alt"></i> R√©-entra√Æner';
            this.disabled = false;
        });
});
</script>
{% endblock %}
